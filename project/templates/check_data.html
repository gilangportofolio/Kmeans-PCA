{% include 'header.html' %}

<div class="container-fluid">
    <!-- Analisis Data -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Analisis Data</h6>
        </div>
        <div class="card-body">
            <!-- Info Umum -->
            <h5>Informasi Dataset:</h5>
            <ul>
                <li>Total Data: {{ analysis.info_umum.jumlah_baris }} baris</li>
                <li>Data Bermasalah: {{ comparison.changes.jumlah_sasaran_bermasalah }} baris</li>
                <li>Total Missing Values: {{ comparison.changes.total_missing_before }}</li>
            </ul>

            <!-- Masalah Data -->
            {% if masalah %}
            <div class="alert alert-warning">
                <h5>Detail Data Bermasalah:</h5>
                <div class="table-responsive">
                    <table class="table table-bordered table-sm">
                        <thead>
                            <tr>
                                <th>Nama Sasaran</th>
                                <th>Detail Masalah</th>
                            </tr>
                        </thead>
                        <tbody>
                        {% for m in masalah %}
                            <tr>
                                <td>{{ m.sasaran }}</td>
                                <td>{{ m.detail }}</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}
            
            <!-- Tombol Aksi -->
            <div class="mt-3">
                <div class="form-group">
                    <label for="cleanMethod">Metode Perbaikan Data:</label>
                    <select class="form-control" id="cleanMethod" style="width: 200px;">
                        <option value="interpolate">Interpolasi Linear</option>
                        <option value="mean">Rata-rata</option>
                        <option value="median">Nilai Tengah</option>
                        <option value="ffill">Forward Fill</option>
                        <option value="unique">Variasi Data Berurutan</option>
                    </select>
                    <small class="form-text text-muted">
                        <ul>
                            <li>Interpolasi Linear: Mengisi berdasarkan tren data</li>
                            <li>Rata-rata: Menggunakan rata-rata data yang tersedia</li>
                            <li>Nilai Tengah: Menggunakan median data yang tersedia</li>
                            <li>Forward Fill: Menggunakan nilai sebelumnya</li>
                            <li>Variasi Data: Membuat variasi untuk data berurutan yang sama dengan perubahan:
                                <ul>
                                    <li>±3% untuk bulan pertama</li>
                                    <li>±7% untuk bulan kedua</li>
                                    <li>±9% untuk bulan ketiga</li>
                                    <li>±13% untuk bulan keempat</li>
                                </ul>
                            </li>
                        </ul>
                    </small>
                </div>
                
                <button class="btn btn-success" onclick="saveChanges('new')">
                    Simpan Sebagai File Baru
                </button>
                <button class="btn btn-warning" onclick="saveChanges('replace')">
                    Replace File Asli
                </button>
                <a href="{{ url_for('index') }}" class="btn btn-secondary">
                    Batal
                </a>
            </div>
        </div>
    </div>
    
    <!-- Preview Perubahan -->
    {% if comparison.original %}
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Preview Data</h6>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered" id="previewTable">
                    <thead>
                        <tr>
                            <th>No</th>
                            <th>Sasaran</th>
                            <th>Data Asli</th>
                            <th>Data Setelah Diproses</th>
                        </tr>
                    </thead>
                    <tbody id="previewBody">
                        <!-- Data akan diisi oleh JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
function updatePreview() {
    $.ajax({
        url: '/preview_cleaning',
        method: 'POST',
        data: {
            method: $('#cleanMethod').val()
        },
        success: function(response) {
            console.log("Response received:", response);
            
            const previewBody = document.getElementById('previewBody');
            if (!previewBody) {
                console.error("Preview body element not found!");
                return;
            }

            if (response.success && response.preview) {
                let html = '';
                const preview = response.preview;
                
                for (let i = 0; i < preview.original.length; i++) {
                    const orig = preview.original[i];
                    const clean = preview.cleaned[i];
                    
                    html += `
                        <tr>
                            <td>${i + 1}</td>
                            <td>${orig.Sasaran}</td>
                            <td>${JSON.stringify(orig)}</td>
                            <td>${JSON.stringify(clean)}</td>
                        </tr>
                    `;
                }
                
                previewBody.innerHTML = html;
            } else {
                previewBody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center text-danger">
                            ${response.error || 'Terjadi kesalahan saat memuat preview'}
                        </td>
                    </tr>
                `;
            }
        },
        error: function(err) {
            console.error("Error:", err);
            const previewBody = document.getElementById('previewBody');
            if (previewBody) {
                previewBody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center text-danger">
                            Gagal memuat preview: ${err.statusText}
                        </td>
                    </tr>
                `;
            }
        }
    });
}

// Tunggu sampai DOM selesai dimuat
document.addEventListener('DOMContentLoaded', function() {
    console.log("DOM loaded, setting up event listeners");
    
    const methodSelect = document.getElementById('cleanMethod');
    if (methodSelect) {
        methodSelect.addEventListener('change', updatePreview);
        // Panggil updatePreview untuk pertama kali
        updatePreview();
    } else {
        console.error("Method select element not found!");
    }
});

// Fungsi save
function saveChanges(option) {
    if (!confirm('Anda yakin ingin menyimpan perubahan?')) return;
    
    const method = document.getElementById('cleanMethod').value;
    
    $.ajax({
        url: '/handle_missing',
        method: 'POST',
        data: { 
            save_option: option,
            method: method 
        },
        success: function(response) {
            alert(response.message);
            window.location.href = "{{ url_for('index') }}";
        },
        error: function(err) {
            alert('Terjadi kesalahan: ' + err.responseJSON?.error || 'Unknown error');
        }
    });
}
</script>

{% include 'footer.html' %} 