{% include 'header.html' %}

<div class="container-fluid">
    <!-- Header dengan Info -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">Analisis Cluster K-Means</h1>
        {% if error %}
        <div class="alert alert-danger">{{ error }}</div>
        {% endif %}
    </div>

    <!-- Row 1: Input dan Informasi -->
    <div class="row">
        <!-- Input Form -->
        <div class="col-xl-4">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Parameter Clustering</h6>
                    <i class="fas fa-question-circle" data-toggle="tooltip" title="Masukkan jumlah cluster yang diinginkan"></i>
                </div>
                <div class="card-body">
                    <form method="POST">
                        <div class="form-group">
                            <label>Jumlah Cluster (K)</label>
                            <input type="number" name="jumlah_klaster" class="form-control" min="2" required>
                            <small class="form-text text-muted">
                                <i class="fas fa-info-circle"></i> Panduan:
                                <ul>
                                    <li>Minimal: 2 cluster</li>
                                    <li>Maksimal: {{ data|length - 1 }} cluster</li>
                                    <li>Rekomendasi: Gunakan Elbow Method sebagai panduan</li>
                                </ul>
                            </small>
                        </div>
                        <div class="d-flex">
                            <button type="submit" class="btn btn-primary mr-2">
                                <i class="fas fa-play"></i> Proses Clustering
                            </button>
                            {% if cluster_data %}
                            <a href="{{ url_for('download_cluster') }}" class="btn btn-success">
                                <i class="fas fa-download"></i> Download Hasil
                            </a>
                            {% endif %}
                        </div>
                    </form>
                </div>
            </div>
        </div>

        {% if visualisasi %}
        <!-- Pie Chart yang lebih bersih -->
        <div class="col-xl-4">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Distribusi Cluster</h6>
                    <i class="fas fa-chart-pie" data-toggle="tooltip" title="Menampilkan proporsi data dalam setiap cluster"></i>
                </div>
                <div class="card-body">
                    <div class="chart-pie pt-4">
                        <canvas id="clusterPieChart"></canvas>
                    </div>
                    <div class="mt-3 text-center small">
                        <i class="fas fa-info-circle"></i> 
                        Menunjukkan persentase distribusi data di setiap kelompok
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="col-xl-4">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Ringkasan Hasil</h6>
                    <i class="fas fa-info-circle" data-toggle="tooltip" title="Ringkasan metrik evaluasi clustering"></i>
                </div>
                <div class="card-body">
                    <!-- Silhouette Score Card -->
                    <div class="mb-4">
                        <div class="card border-left-{{ 'success' if evaluasi.silhouette.score > 0.7 else 
                                                      'info' if evaluasi.silhouette.score > 0.5 else 
                                                      'warning' if evaluasi.silhouette.score > 0.25 else 
                                                      'danger' }} shadow h-100 py-2">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                            Silhouette Score
                                        </div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800">
                                            {{ evaluasi.silhouette.score|round(3) }}
                                        </div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="fas fa-chart-line fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Other Stats -->
                    <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                        Statistik Tambahan
                    </div>
                    <div class="h6 mb-3 font-weight-bold text-gray-800">
                        <ul class="list-unstyled">
                            <li><i class="fas fa-layer-group"></i> Jumlah Cluster: {{ cluster_data|length }}</li>
                            <li><i class="fas fa-database"></i> Total Data: {{ data|length }}</li>
                            <li><i class="fas fa-chart-bar"></i> Davies-Bouldin: {{ evaluasi.davies_bouldin|round(3) }}</li>
                            <li><i class="fas fa-calculator"></i> WCSS: {{ evaluasi.wcss|round(3) }}</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Setelah Row 1, tambahkan Row baru untuk detail kelompok -->
    <div class="row mt-4">
        <div class="col-xl-12">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Detail Kelompok</h6>
                    <i class="fas fa-info-circle" data-toggle="tooltip" title="Informasi detail untuk setiap kelompok cluster"></i>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for cluster in cluster_data %}
                        <div class="col-xl-4 col-md-6 mb-4">
                            <div class="card border-left-{{ cluster.color_class }} shadow h-100">
                                <div class="card-header py-3 d-flex align-items-center justify-content-between">
                                    <h6 class="m-0 font-weight-bold text-{{ cluster.color_class }}">
                                        {{ cluster.name }} ({{ cluster.count }} sasaran)
                                    </h6>
                                    <i class="fas fa-circle" style="color: {{ cluster.color }}"></i>
                                </div>
                                <div class="card-body">
                                    <!-- Karakteristik Cluster -->
                                    <div class="mb-2">
                                        <span class="font-weight-bold">Karakteristik:</span>
                                        <span class="badge badge-{{ cluster.color_class }}">{{ cluster.karakteristik }}</span>
                                    </div>
                                    
                                    <!-- Statistik -->
                                    <div class="small mb-2">
                                        <div><i class="fas fa-chart-line"></i> Rata-rata: {{ cluster.mean_value|round(3) }}</div>
                                        <div><i class="fas fa-arrow-down"></i> Minimum: {{ cluster.min_value|round(3) }}</div>
                                        <div><i class="fas fa-arrow-up"></i> Maksimum: {{ cluster.max_value|round(3) }}</div>
                                    </div>

                                    <!-- Daftar Sasaran -->
                                    <div class="mt-3">
                                        <span class="font-weight-bold">Anggota Kelompok:</span>
                                        <div class="list-group mt-2">
                                            {% for sasaran in cluster.sasaran %}
                                            <div class="list-group-item list-group-item-action flex-column align-items-start py-2">
                                                <div class="d-flex w-100 justify-content-between">
                                                    <h6 class="mb-1">{{ sasaran }}</h6>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Row 2: Visualisasi -->
    <div class="row">
        <!-- Elbow Method -->
        <div class="col-xl-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Elbow Method</h6>
                    <i class="fas fa-question-circle" data-toggle="tooltip" 
                       title="Metode untuk menentukan jumlah cluster optimal. Titik siku menunjukkan jumlah cluster yang disarankan."></i>
                </div>
                <div class="card-body">
                    <canvas id="elbowChart"></canvas>
                    <div class="mt-3 small text-muted">
                        <i class="fas fa-info-circle"></i> 
                        Panduan: Pilih jumlah cluster pada titik dimana grafik mulai melandai (titik siku).
                    </div>
                </div>
            </div>
        </div>

        <!-- Silhouette Analysis -->
        <div class="col-xl-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Silhouette Analysis</h6>
                    <i class="fas fa-question-circle" data-toggle="tooltip" 
                       title="Visualisasi kualitas clustering. Semakin tinggi nilai (mendekati 1), semakin baik."></i>
                </div>
                <div class="card-body">
                    <canvas id="silhouetteChart"></canvas>
                    <div class="mt-3">
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered">
                                <thead>
                                    <tr>
                                        <th>Range</th>
                                        <th>Interpretasi</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="{{ 'table-success font-weight-bold' if evaluasi.silhouette.score > 0.7 }}">
                                        <td>0.7 - 1.0</td>
                                        <td>Struktur cluster sangat baik</td>
                                    </tr>
                                    <tr class="{{ 'table-info font-weight-bold' if 0.5 < evaluasi.silhouette.score <= 0.7 }}">
                                        <td>0.5 - 0.7</td>
                                        <td>Struktur cluster baik</td>
                                    </tr>
                                    <tr class="{{ 'table-warning font-weight-bold' if 0.25 < evaluasi.silhouette.score <= 0.5 }}">
                                        <td>0.25 - 0.5</td>
                                        <td>Struktur cluster lemah</td>
                                    </tr>
                                    <tr class="{{ 'table-danger font-weight-bold' if evaluasi.silhouette.score <= 0.25 }}">
                                        <td>< 0.25</td>
                                        <td>Tidak ada struktur cluster yang jelas</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Load Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4"></script>
<script src="{{ url_for('static', filename='js/cluster_visualization.js') }}"></script>

{% if visualisasi %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        initializeVisualizations(
            {{ cluster_data|tojson|safe }},
            {{ evaluasi|tojson|safe }},
            {{ visualisasi|tojson|safe }}
        );
        
        // Initialize tooltips
        $('[data-toggle="tooltip"]').tooltip();
    });
</script>
{% endif %}

{% include 'footer.html' %}
